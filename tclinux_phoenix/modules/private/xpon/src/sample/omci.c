#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/socket.h>
#include <sys/ioctl.h>
#include <linux/netdevice.h>
#include <linux/if_packet.h>
#include <linux/if_ether.h>
#include <linux/if_arp.h>

#define OMCI_MAX_LENS		2000

int omci_socket = -1 ;
struct sockaddr_ll socket_addr ;

/******************************************************************************
******************************************************************************/
int omci_receive(int *pLen, char *pkts)
{
	int pktLen = 0 ; /*length of the received frame*/ 

	pktLen = recvfrom(omci_socket, pkts, OMCI_MAX_LENS, 0, NULL, NULL) ;
	if(pktLen < 0) {
		printf("receive omci data error\n") ;
		return -1 ;
	}
	*pLen = pktLen ;
	
	return 0 ;
}

/******************************************************************************
******************************************************************************/
int omci_transmit(int len, char *pkts)
{
	int result ;
	
	result = sendto(omci_socket, pkts, len, 0, (struct sockaddr*)&socket_addr, sizeof(socket_addr)) ;
	if(result == -1) { 
		printf("send omci data error\n") ;
		return -1 ;
	}
	return 0 ;
}

/******************************************************************************
******************************************************************************/
int omci_init(void)
{
	struct ifreq ifstruct ; 

	omci_socket = socket(AF_PACKET, SOCK_RAW, htons(ETH_P_ALL)) ;
	if(omci_socket == -1) { 
		printf("create omci socket failed\n") ;
		return -1 ;
	}

	/*RAW communication*/
	socket_addr.sll_family = AF_PACKET ;// PF_PACKET ;	
	socket_addr.sll_protocol = htons(ETH_P_ALL) ;
	strcpy(ifstruct.ifr_name, "omci") ;
	ioctl(omci_socket, SIOCGIFINDEX, &ifstruct) ; 
	socket_addr.sll_ifindex  = ifstruct.ifr_ifindex ;

	if(bind(omci_socket, (struct sockaddr *)&socket_addr, sizeof(socket_addr)) == -1) { 
		printf("binding omci socket failed\n") ;
		close(omci_socket) ;
		omci_socket = -1 ;
		return -1 ;
	}
	
	return 0 ;
}

/******************************************************************************
******************************************************************************/
int omci_destroy(void)
{
	if(omci_socket >= 0) {
		close(omci_socket) ;	
	}
}

/******************************************************************************
******************************************************************************/
int main(int argc, char **argv) 
{
	int pktLen ;
	unsigned char pktBuff[OMCI_MAX_LENS] ;
	unsigned char n ;
	int i ;
	char onuDataOmci[44] 		= {0x00, 0x00, 0x49, 0x0A, 0x00, 0x02, 0x00, 0x00,
								   0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x28} ;
/*	char onuDataOmciResp[44] 	= {0x00, 0x00, 0x29, 0x0A, 0x00, 0x02, 0x00, 0x00,
								   0x00, 0x80, 0x00, 0x06, 0x00, 0x00, 0x00, 0x00, 
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x28} ;
*/	
	char onuDataOmciResp[44] 	= {0x00, 0x00, 0x29, 0x0A, 0x00, 0x02, 0x00, 0x00,
								   0x00, 0x80, 0x00, 0x16, 0x00, 0x00, 0x00, 0x00, 
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x28} ;

	char classId247Omci[44] 	= {0x00, 0x00, 0x49, 0x0A, 0x00, 0xF7, 0x00, 0x00,
								   0xF0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x28} ;
	char classId247OmciResp[44] = {0x00, 0x00, 0x29, 0x0A, 0x00, 0xF7, 0x00, 0x00,
								   0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x28} ;
	
	char softImageOmci[44] 		= {0x00, 0x00, 0x49, 0x0A, 0x00, 0x07, 0x00, 0x00,
								   0xF0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x28} ;
	char softImageOmciResp[44] 	= {0x00, 0x00, 0x29, 0x0A, 0x00, 0x07, 0x00, 0x00,
								   0x00, 0xF0, 0x00, 0x56, 0x32, 0x2E, 0x33, 0x30, 
								   0x2E, 0x31, 0x30, 0x54, 0x36, 0x53, 0x00, 0x00,
								   0x00, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x28} ;
	
	char softImage1Omci[44] 	= {0x00, 0x00, 0x49, 0x0A, 0x00, 0x07, 0x00, 0x01,
								   0xF0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x28} ;
	char softImage1OmciResp[44]	= {0x00, 0x00, 0x29, 0x0A, 0x00, 0x07, 0x00, 0x01,
								   0x00, 0xF0, 0x00, 0x56, 0x32, 0x2E, 0x33, 0x30, 
								   0x2E, 0x31, 0x30, 0x54, 0x36, 0x53, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x28} ;

	char onuAlarmOmci[44] 		= {0x00, 0x00, 0x4B, 0x0A, 0x00, 0x02, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x28} ;
	char onuAlarmOmciResp[44] 	= {0x00, 0x00, 0x2B, 0x0A, 0x00, 0x02, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x28} ;

	char onuAlarmNextOmci[44] 	= {0x00, 0x00, 0x4C, 0x0A, 0x00, 0x02, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x28} ;
	char onuAlarmNextOmciResp[44]= {0x00, 0x00, 0x2C, 0x0A, 0x00, 0x02, 0x00, 0x00,
								   0x01, 0x07, 0x80, 0x01, 0x10, 0x00, 0x00, 0x00, 
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x28} ;

	char onuTcontOmci[44] 		= {0x00, 0x00, 0x48, 0x0A, 0x01, 0x06, 0x80, 0x01,
								   0x80, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x28} ;
	char onuTcontOmciResp[44]	= {0x00, 0x00, 0x28, 0x0A, 0x01, 0x06, 0x80, 0x01,
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x28} ;
	char onuGOmci[44]			= {0x00, 0x00, 0x49, 0x0A, 0x01, 0x00, 0x00, 0x00,
								   0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x28} ;
	char onuGOmciResp[44]		= {0x00, 0x00, 0x29, 0x0A, 0x01, 0x00, 0x00, 0x00,
								   0x00, 0x40, 0x00, 0x56, 0x32, 0x2e, 0x33, 0x30,
								   0x2e, 0x31, 0x30, 0x54, 0x36, 0x53, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
								   0x00, 0x00, 0x00, 0x28} ;
	char classId247_2Omci[44]	 	= {0x00, 0x00, 0x49, 0x0A, 0x00, 0xF7, 0x00, 0x00,
									   0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
									   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
									   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
									   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
									   0x00, 0x00, 0x00, 0x28} ;
	char classId247_2OmciResp[44]	= {0x00, 0x00, 0x29, 0x0A, 0x00, 0xF7, 0x00, 0x00,
									   0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
									   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
									   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
									   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
									   0x00, 0x00, 0x00, 0x28} ;
	char classId65530_1Omci[44]	 	= {0x00, 0x00, 0x49, 0x0A, 0xFF, 0xFA, 0x00, 0x00,
									   0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
									   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
									   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
									   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
									   0x00, 0x00, 0x00, 0x28} ;
//	char classId65530_1OmciResp[44]	= {0x00, 0x00, 0x29, 0x0A, 0xFF, 0xFA, 0x00, 0x00,
//									   0x00, 0x40, 0x00, 0x5A, 0x54, 0x45, 0x47, 0x43, 
//									   0x30, 0x30, 0x30, 0x36, 0x39, 0x46, 0x36, 0x00,
//									   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//									   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//									   0x00, 0x00, 0x00, 0x28} ;
	char classId65530_1OmciResp[44]	= {0x00, 0x00, 0x29, 0x0A, 0xFF, 0xFA, 0x00, 0x00,
									   0x00, 0x40, 0x00, 0x30, 0x31, 0x32, 0x33, 0x34, 
									   0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x31, 0x32,
									   0x33, 0x34, 0x35, 0x00, 0x00, 0x00, 0x00, 0x00,
									   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
									   0x00, 0x00, 0x00, 0x28} ;
	char classId65530_2Omci[44]	 	= {0x00, 0x00, 0x49, 0x0A, 0xFF, 0xFA, 0x00, 0x00,
									   0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
									   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
									   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
									   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
									   0x00, 0x00, 0x00, 0x28} ;
	char classId65530_2OmciResp[44]	= {0x00, 0x00, 0x29, 0x0A, 0xFF, 0xFA, 0x00, 0x00,
									   0x00, 0x20, 0x00, 0x32, 0x32, 0x32, 0x32, 0x32, 
									   0x32, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
									   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
									   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
									   0x00, 0x00, 0x00, 0x28} ;
	char classId65530_3Omci[44]		= {0x00, 0x00, 0x48, 0x0A, 0xFF, 0xFA, 0x00, 0x00,
									   0x10, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 
									   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
									   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
									   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
									   0x00, 0x00, 0x00, 0x28} ;
	char classId65530_3OmciResp[44]	= {0x00, 0x00, 0x28, 0x0A, 0xFF, 0xFA, 0x00, 0x00,
									   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
									   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
									   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
									   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
									   0x00, 0x00, 0x00, 0x28} ;
	char classId65530_4Omci[44]		= {0x00, 0x00, 0x48, 0x0A, 0xFF, 0xFA, 0x00, 0x00,
									   0x10, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 
									   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
									   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
									   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
									   0x00, 0x00, 0x00, 0x28} ;
	char classId65530_4OmciResp[44]	= {0x00, 0x00, 0x28, 0x0A, 0xFF, 0xFA, 0x00, 0x00,
									   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
									   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
									   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
									   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
									   0x00, 0x00, 0x00, 0x28} ;
	omci_init() ;

/*	if(!strcmp(argv[1], "tx")) {
		for(i=0 ; i<48 ; i++) {
			pktBuff[i] = i ;
		}
		
		omci_transmit(48, pktBuff) ;

		printf("------------>transmit pktLen: %d\n", 48) ;
		for(i=0 ; i<48 ; i++) {
			n = i & 0x0f ;
			if(n == 0x00) 		printf("\n%.4x: ", i) ;
			else if(n == 0x08) 	printf(" ") ;
			printf("%.2x ", pktBuff[i]) ; 
		}
		printf("\n") ;
		return 0 ;
	}
*/	

printf("----->argc:%d, argv[1]:%s\n", argc, argv[1]) ;

	while(1) {
		omci_receive(&pktLen, pktBuff) ;

/*		printf("------------>receive pktLen: %d\n", pktLen) ;
		for(i=0 ; i<pktLen ; i++) {
			n = i & 0x0f ;
			if(n == 0x00) 		printf("\n%.4x: ", i) ;
			else if(n == 0x08) 	printf(" ") ;
			printf("%.2x ", pktBuff[i]) ; 
		}
		printf("\n") ;
*/		

		if(!memcmp(pktBuff+2, onuDataOmci+2, 42)) {
			memcpy(pktBuff+2, onuDataOmciResp+2, 42) ;
			if(argc >= 2) {
				pktBuff[11] = strtol(argv[1], NULL, 0) ;
			}
		} else if(!memcmp(pktBuff+2, classId247Omci+2, 42)) {
			memcpy(pktBuff+2, classId247OmciResp+2, 42) ;
		} else if(!memcmp(pktBuff+2, softImageOmci+2, 42)) {
			memcpy(pktBuff+2, softImageOmciResp+2, 42) ;
		} else if(!memcmp(pktBuff+2, softImage1Omci+2, 42)) {
			memcpy(pktBuff+2, softImage1OmciResp+2, 42) ;
		} else if(!memcmp(pktBuff+2, onuAlarmOmci+2, 42)) {
			memcpy(pktBuff+2, onuAlarmOmciResp+2, 42) ;
		} else if(!memcmp(pktBuff+2, onuAlarmNextOmci+2, 42)) {
			memcpy(pktBuff+2, onuAlarmNextOmciResp+2, 42) ;
		} else if(!memcmp(pktBuff+2, onuTcontOmci+2, 5)) {
			memcpy(pktBuff+2, onuTcontOmciResp+8, 36) ;
			pktBuff[2] = ((pktBuff[2] & ~0x40) | 0x20) ;
		} 
		
		else if(!memcmp(pktBuff+2, onuGOmci+2, 42)) {
			memcpy(pktBuff+2, onuGOmciResp+2, 42) ;
		} else if(!memcmp(pktBuff+2, classId247_2Omci+2, 42)) {
			memcpy(pktBuff+2, classId247_2OmciResp+2, 42) ;
		} else if(!memcmp(pktBuff+2, classId65530_1Omci+2, 42)) {
			memcpy(pktBuff+2, classId65530_1OmciResp+2, 42) ;
			if(argc >= 3) {
				strcpy(&pktBuff[11], argv[2]) ;
			}
		} else if(!memcmp(pktBuff+2, classId65530_2Omci+2, 42)) {
			memcpy(pktBuff+2, classId65530_2OmciResp+2, 42) ;
			if(argc >= 4) {
				strcpy(&pktBuff[11], argv[3]) ;
			}
		} else if(!memcmp(pktBuff+2, classId65530_3Omci+2, 42)) {
			memcpy(pktBuff+2, classId65530_3OmciResp+2, 42) ;
		} else if(!memcmp(pktBuff+2, classId65530_4Omci+2, 42)) {
			memcpy(pktBuff+2, classId65530_4OmciResp+2, 42) ;
		} else {
			printf("------------>unknown OMCI message\n") ;	
			continue ;
		}

		omci_transmit(pktLen, pktBuff) ;

/*		printf("------------>transmit pktLen: %d\n", pktLen) ;
		for(i=0 ; i<pktLen ; i++) {
			n = i & 0x0f ;
			if(n == 0x00) 		printf("\n%.4x: ", i) ;
			else if(n == 0x08) 	printf(" ") ;
			printf("%.2x ", pktBuff[i]) ; 
		}
		printf("\n") ;
*/	}
	
	omci_destroy() ;
}

